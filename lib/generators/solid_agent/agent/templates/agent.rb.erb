# frozen_string_literal: true

class <%= class_name %>Agent < <%= @parent_class %>
<%- if @include_context || @include_tools || @include_streaming -%>
  # SolidAgent concerns
<%- end -%>
<%- if @include_context -%>
  include SolidAgent::HasContext
<%- end -%>
<%- if @include_tools -%>
  include SolidAgent::HasTools
<%- end -%>
<%- if @include_streaming -%>
  include SolidAgent::StreamsToolUpdates
<%- end -%>

  # Configure the generation provider and model
  generate_with :openai, model: "gpt-4o"

<%- if @include_context -%>
  # Enable database-backed context persistence
  # Context is auto-created from params[:<%= @contextable || 'contextable' %>]
<%- if @context_name -%>
  has_context :<%= @context_name %>, contextable: :<%= @contextable || 'contextable' %>
<%- else -%>
  has_context contextable: :<%= @contextable || 'contextable' %>
<%- end -%>
<%- end -%>

<%- if @include_tools -%>
  # Declare tools (auto-discover from app/views/<%= file_name %>_agent/tools/*.json.erb)
  # has_tools
  #
  # Or declare specific tools:
  # has_tools :search, :analyze
  #
  # Or define inline:
  # tool :example do
  #   description "An example tool"
  #   parameter :input, type: :string, required: true
  # end
<%- end -%>

<%- if @include_streaming -%>
  # Streaming callbacks for real-time updates
  on_stream :broadcast_chunk
  on_stream_close :broadcast_complete

  # Tool descriptions for UI feedback
  # tool_description :search, ->(args) { "Searching for '#{args[:query]}'..." }
<%- end -%>

<%- @actions.each do |action| -%>
  # Action: <%= action %>
  def <%= action %>
<%- if @include_tools -%>
    # Include tools in the prompt (context auto-created)
    prompt(tools: tools, tool_choice: "auto")
<%- else -%>
    # Render the action template (context auto-created)
    prompt
<%- end -%>
  end

<%- end -%>
<%- if @include_streaming -%>
  private

  def broadcast_chunk(chunk)
    return unless chunk.delta
    return unless params[:stream_id]

    ActionCable.server.broadcast(params[:stream_id], { content: chunk.delta })
  end

  def broadcast_complete(chunk)
    return unless params[:stream_id]

    ActionCable.server.broadcast(params[:stream_id], { done: true })
  end
<%- end -%>
<%- if @include_tools && !@include_streaming -%>
  private

  # Tool implementations go here
  # def search(query:)
  #   Rails.logger.info "[<%= class_name %>Agent] Tool called: search(#{query})"
  #   { success: true, results: [] }
  # rescue => e
  #   { success: false, error: e.message }
  # end
<%- end -%>
end
