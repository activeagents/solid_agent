# frozen_string_literal: true

# <%= generation_class_name %> stores LLM generation results for a <%= context_name %>.
#
class <%= generation_class_name %> < ApplicationRecord
  # Associations
  belongs_to :<%= file_name %>

  # Scopes
  scope :recent, -> { order(created_at: :desc) }
  scope :by_model, ->(model) { where(model: model) }
  scope :with_tool_calls, -> { where.not(tool_calls: []) }
  scope :completed, -> { where(finish_reason: "stop") }

  def total_tokens
    input_tokens + output_tokens
  end

  def has_tool_calls?
    tool_calls.present? && tool_calls.any?
  end

  def completed?
    finish_reason == "stop"
  end

  def truncated?
    finish_reason == "length"
  end

  def ended_with_tool_calls?
    finish_reason == "tool_calls"
  end

  def estimated_cost(input_price_per_million: 3.0, output_price_per_million: 15.0)
    input_cost = (input_tokens / 1_000_000.0) * input_price_per_million
    output_cost = (output_tokens / 1_000_000.0) * output_price_per_million
    input_cost + output_cost
  end
end
